# ya_practicum_project2
sprint4 Determining the number of calories in a dish from a photo, text the weight of the dish  
"проходимость" модели по условиям задачи составляет MAE < 50 (достигнуто 43.6 ккал)

**update 23-Nov-2025 23:30**  
**добавлен механизм multihead cross-attention, MAE = 42.6 ккал**  
**train_3_cross_attent.ipynb - ноутбук с обучением и тестированием** 
**utils3_cross_attention.py - скорректированная модель находится здесь**  
**test3_cross_attention.py - исходный код для тестирования модели**  

**Структура проекта:**  
```plaintext
ya_practicum_project2/
├── data/                            # Датасеты
│   ├── images                       # изображения блюд в папках соответсвующих dish_id (не размещен)
│   ├── dish.csv                     # исходный файл содержащий dish_id, ingredients (перечень кодов ингредиентов), общая калорийность и масса блюда
│   ├── ingredients.csv              # исходный файл содержащий словарь кодов ингредиентов и их названий
│   ├── train_data.csv               # подготовленная обучающая выборка (внесены изменения по аномалиям, притянуты названия ингредиентов)
│   └── test_data.csv                # подготовленная тестовая/валидационная выборка по аналогии с обучающей
│
├── models/                          # веса обученных моделей (не размещены в виду ограничений github)
│
├── config.py                        # файл конфигурации модели и обучения   
├── dataset.py                       # создание класса датасета, аугментаций
├── 1_data_transform.ipynb           # ноутбук загрузки первичных данных, преобразования аномалий, сохранения train_data.csv/test_data.csv
├── 2_load_data.ipynb                # ноутбук оценкой данных
├── train.py                         # код запуска обучения
├── train.ipynb                      # ноутбук с запуском и логированием обучения
├── utils2.py                        # здесь находится класс модели, функция обучения и валидации, а также визуализации результатов
├── train_3_cross_attent.ipynb       # ноутбук обучения и тестирования модели с кросс-аттеншен
├── utils3_cross_attention.py        # здесь находится класс модели, функция обучения и валидации, а также визуализации результатов
└── test3_cross_attention.py         # здесь находится функционал для тестирования модели, выбора наихудших результатов 
```

# Подходы к решению задачи по определению калорийности блюд.
## Саммари: 
-- в разведочном анализе данных найдены аномалии, проведены корректировки.   
-- использовалась мультимодальная модель. Для изображений использовалась легкая модель "tf_efficientnet_b0" - быстрое обучение на локальной машине с 1GPU(8Gb), а "bert-base-uncased" - для текста. Третяя вводная - это вес блюда, который приводился к вектору размерности 128. Затем вектора приводились в единое пространсто признаков, и далее конкатенировались. Количество калорий определялось 3х слойным полносвязными слоями со снижением размерности ( 1152 -> 512 -> 256 -> 1 )  
-- механизм Attention не использовался  
-- получен результат MAE=43.6 ккал  

## Детали:
### 0) предобработка данных.
   исходные данные содержат изображения блюд, текстовое описание ингредиентов, данные общей массы блюда и общей клорийности.   Особенности данных:  
-- наблюдение, есть некоторое количество повторяющихся блюд с 1 ингредиентом, моно-ингридиент содержит одинаковое количество калорий на 1 мг, что позволяет предположить, что калории в блюдах подсчитаны исходя из массы каждого ингредиента  
-- в данных есть выбросы, которые исключаем - аномальный вес и количество калорий  
dish_1560974769, вес 3 051,0  
-- в данных присутсвуют пустые тарелки, также исключаем dish_id содержащий ингредиент "пустая тарелка"  
ingr 423	plate only  
-- в данных присутствуют повторяющиеся значения "deprecated" (видимо "устаревшие" записи), в виду их повторяемости и неоднозначности, это может повлиять на точность модели, поэтому также исключаем dish_id со следующими ингредиентами:  
id	ingr  
231	deprecated  
453	deprecated 6/15 (test/train)  
458	deprecated 2/8 (test/train)  
470	deprecated  
-- исключаем ингредиент "соль", т.к. он не оказывает влияние на калорийность, но может также повлиять на точность модели  
salt	ingr_0000000291  
-- есть блюда в тест (валидация), но их нет в выборке трейн, логично было бы использовать такие блюда именно в обучающей выборке выборке. Таким образом ингредиент bread и tuna salad перенесены из test(val) -> train. Переносим только однокомпонентные блюда, а многокомпонентые с этими ингредиентами по прежнему остаются в выборке test(val)  
bread  
dish_1562085672 переводим из test в train., т.к. однокомпонентный  
tuna salad  
dish_1568401167 - переводим из test в train., т.к. однокомпонентный  
tuna salad многокомпонентные, которые остаются в test/val выборке  
dish_1568401199  
dish_1568401233  
dish_1568401261  
dish_1568401302  
  
### 1) структура модели 
Калорийность блюда определяется из трех вводных: изображения блюда, перечня ингредиентов и массы блюда. В наличии у нас две модальности, поэтому используем мультимодальную структуру модели.  
Для каждой модальности возьмем модели хорошо зарекомендовавшие себя в предыдущих уроках:  
   TEXT_MODEL_NAME = "bert-base-uncased" #модель для получения эмебеддингов текста, т.е. ингредиентов  
   IMAGE_MODEL_NAME = "tf_efficientnet_b0" # небольшая модель (~5.3 млн.параметров), с быстрым инференсом, и достаточным уровнем точности (~78%)для получения эмбеддингов изображений блюд. Параметры модели позволяют использовать меньше ресурсов при обучении.  
  Масса блюда - важный параметр для определения калорийности, вес блюда будет преобразован через полносвязный слой в вектор размерности 128.  
  
После преобразования данных эмбеддингов в единое пространство признаков проводим конкатенацию векторов каждой модальности.  
  fusion_dim = config.HIDDEN_DIM * 2 + config.HIDDEN_DIM // 4  # 512 + 512 + 128 = 1152  
  fused_emb = torch.cat([text_emb, image_emb, mass_emb], dim=1)  # (batch, 1152)  
  
Далее мы используем 3 полносвязных слоя для получения одного значения - число калорий ( 1152 -> 512 -> 256 -> 1 )  
  
### 2) подходы к обогащению/аугментации данных 
 Аугментация изображений:  
RandomCrop - вырезаем случайный фрагмент, обучаем нейросеть с недостающими частями изображения  
Affine - афинные преобразования, имитируем разные положения камеры  
CoarseDropout - закрываем часть изображения, с одной стороны работает на предотвращение переобучения модели на конкретные текстуры модели, с другой стороны имитирует ситуации, когда часть блюда не видна  
ColorJitter - компенсируем разные условия освещения  
 Аугментация текста (ингредиентов): не использовалась, т.к. использовался пред-обученный готовый эмбеддер, способный находить эмбеддинги при ошибках в написании и словах-синонима (должны получиться близкие вектора эмбеддингов)     

### 4) основная метрика качества обучения 
loss = nn.MSELoss() - обучение сильнее наказывает за ошибки за счет квадратичной функции  
Так как условие задачи составляет MAE < 50, то выбор лучшей модели (сохранение модели) осуществляем по MAE.  

### Результаты обучения модели
<img width="973" height="318" alt="image" src="https://github.com/user-attachments/assets/6421d07e-f7b5-4661-aa8b-4496505af159" />

### Анализ плохих результатов.
73% оценок на тестовой выборке лежали в диапазоне абсолютной ошибки менее 50 ккал.  
<img width="752" height="452" alt="image" src="https://github.com/user-attachments/assets/80ac4f80-24d4-40df-aa64-d2ee30aab1e4" />

### ТОП-5 наихудших результатов:  
1. dish_1558549806:  
       Предсказано: 368 kcal | Истина: 782 kcal  
       Ошибка: 414 kcal (53.0%)  
       Масса: 203g  
       Ингредиенты: almonds;white rice;spinach (raw)  
2. dish_1566328831:  
       Предсказано: 532 kcal | Истина: 942 kcal  
       Ошибка: 410 kcal (43.5%)  
       Масса: 500g  
       Ингредиенты: pizza;cherry tomatoes;chicken;pineapple;olives  
3. dish_1558720236:  
       Предсказано: 482 kcal | Истина: 888 kcal  
       Ошибка: 406 kcal (45.7%)  
       Масса: 407g  
       Ингредиенты: apple;carrot;cauliflower;almonds  
4. dish_1565811139:  
       Предсказано: 548 kcal | Истина: 902 kcal  
       Ошибка: 354 kcal (39.2%)  
       Масса: 416g  
       Ингредиенты: carrot;goat cheese;olive oil;broccoli;spinach (raw);chicken  
5. dish_1558375886:  
       Предсказано: 697 kcal | Истина: 1051 kcal  
       Ошибка: 353 kcal (33.6%)  
       Масса: 277g  
       Ингредиенты: almonds;sausage;grapes  
  
Причины скорее всего в отсутствии оценки вклада каждого компонента в общую калорийность.  

### Недостатки данной модели и возможности по улучшению:
1) датасет ограничен по размеру, однотипные фотографии (фон, небольшое разнообразие тарелок), также есть повторяемость в данных, например  
   <img width="383" height="364" alt="image" src="https://github.com/user-attachments/assets/828bc658-9f50-4beb-b15f-ba0d2029d58e" />
2) может влиять фон и форма/размер тарелки, т.к. нет обрезки фона в текущей реализации модели  
3) нет учета вклада каждого компонента  
### Возможности по улучшению модели:
1) использовать более точную CNN модель с большим числом параметров  
2) добавить механизм внимания  
3) исключать фон изображения  
4) использовать более sophisticated подход - определять вклад компонентов в калорийность (с использованием RAG), например как в работе https://arxiv.org/html/2412.09936v1
   
<img width="6682" height="3598" alt="image" src="https://github.com/user-attachments/assets/f9931329-48a3-47e2-939e-eb65382519ac" />

   
